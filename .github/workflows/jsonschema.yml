---
name: JSON schema
on:
  push:
    branches:
      - main
      - master
      - develop
      - update-external-dependencies
      - 'release/**'
  pull_request:

jobs:
  json-schema:
    strategy:
      matrix:
        go-version: [ 1.19.x ]
        goarch: [ "amd64" ]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Go
      uses: actions/setup-go@v3
      with:
        go-version: ${{ matrix.go-version }}
      env:
        GOARCH: ${{ matrix.goarch }}

    - uses: actions/setup-python@v1
    - uses: BSFishy/pip-action@v1
      with:
        packages: |
          json-schema-for-humans

    - name: Check if JSON schema and generated doc is up to date
      run: |
        EXPECTED_DIFF=""
        NOT_UPDATED_MSG="JSON Schema is not up to date, run 'make config-doc-gen' before creating the PR"

        echo "Checking if JSON schema is up to date..."
        make GENERATE_DOC_PATH=/tmp/ config-doc-node
        go run ./cmd generate-json-schema --output=docs/config-file/actual-schema.json
        for check_file in "node-config-schema.json" "node-config-doc.md"; do
        ACTUAL_DIFF_JSON_SCHEMA=$(diff /tmp/$check_file docs/config-file/$check_file)
        if [ "$ACTUAL_DIFF_JSON_SCHEMA" != "$EXPECTED_DIFF" ]; then
          echo $ACTUAL_DIFF_JSON_SCHEMA
          echo $NOT_UPDATED_MSG
          exit 1
        fi
        done

        echo "Everything up to date"
